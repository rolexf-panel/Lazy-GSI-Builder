name: Universal Treble GSI Builder

on:
  workflow_dispatch:
    inputs:
      rom_type:
        description: 'Choose ROM Base'
        required: true
        default: 'LineageOS'
        type: choice
        options:
        - LineageOS
        - crDroid
        - DerpFest
        - Evolution X
        - PixelOS
        - ArrowOS
        - Custom (Input URL manually)
      
      custom_manifest_url:
        description: 'Custom Manifest URL (Only if "Custom" selected)'
        required: false
        default: ''

      branch:
        description: 'ROM Branch (e.g., 15.0, fourteen)'
        required: true
        default: '15.0'

      treble_branch:
        description: 'Treble Manifest Branch (Android Version)'
        required: true
        default: 'android-15.0'

      device:
        description: 'Lunch Variant'
        required: true
        default: 'treble_arm64_bvN-userdebug'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Free Up Disk Space
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: ""

      - name: Setup Build Environment
        run: |
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf \
          libxml2 lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev imagemagick \
          git lunzip lzop schedtool squashfs-tools xsltproc zip zlib1g-dev openjdk-17-jdk python3 perl \
          xmlstarlet virtualenv xz-utils rr jq pngcrush lib32ncurses5-dev git-lfs libxml2 > /dev/null 2>&1
          
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure ROM Source
        id: config
        run: |
          case "${{ inputs.rom_type }}" in
            "LineageOS") MANIFEST="https://github.com/LineageOS/android.git" ;;
            "crDroid") MANIFEST="https://github.com/crdroidandroid/android" ;;
            "DerpFest") MANIFEST="https://github.com/DerpFest-12/official_devices" ;;
            "Evolution X") MANIFEST="https://github.com/Evolution-X/manifest" ;;
            "PixelOS") MANIFEST="https://github.com/PixelOS/manifest" ;;
            "ArrowOS") MANIFEST="https://github.com/ArrowOS/android_manifest" ;;
            "Custom (Input URL manually)") MANIFEST="${{ inputs.custom_manifest_url }}" ;;
          esac
          echo "MANIFEST_URL=$MANIFEST" >> $GITHUB_ENV

      - name: Initialize Repo
        run: |
          mkdir -p ~/rom && cd ~/rom
          repo init -u ${{ env.MANIFEST_URL }} -b ${{ inputs.branch }}
          git clone https://github.com/TrebleDroid/treble_manifest .repo/local_manifests -b ${{ inputs.treble_branch }}
          rm -f .repo/local_manifests/replace.xml

      - name: Sync Source
        run: |
          cd ~/rom
          repo sync -c -j4 --force-sync --no-tags --no-clone-bundle --optimized-fetch --prune

      - name: Setup Treble Environment
        run: |
          cd ~/rom
          [ -f device/phh/treble/generate.sh ] && bash device/phh/treble/generate.sh vendor/lineage/config/common_full_phone.mk || echo "Skipping generate script"

      - name: Build GSI
        run: |
          cd ~/rom
          export USE_CCACHE=1
          export CCACHE_DIR=~/rom/.ccache
          export CCACHE_MAXSIZE=5G
          . build/envsetup.sh
          lunch ${{ inputs.device }}
          # Simpan output ke build.log agar bisa diunduh jika error
          WITHOUT_CHECK_API=true make -j$(nproc) systemimage 2>&1 | tee build.log

      - name: Compress Output
        run: |
          cd ~/rom
          find out/target/product -name "system.img" -exec xz -9 -T0 -v -z {} \;

      - name: Upload Build Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gsi-${{ inputs.rom_type }}-${{ inputs.branch }}
          path: ~/rom/out/target/product/*/system.img.xz
          retention-days: 7

      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ inputs.rom_type }}
          path: ~/rom/build.log
          retention-days: 3
