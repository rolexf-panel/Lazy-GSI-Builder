name: Universal Treble GSI Builder

on:
  workflow_dispatch:
    inputs:
      rom_type:
        description: 'Choose ROM Base'
        required: true
        default: 'LineageOS'
        type: choice
        options:
        - LineageOS
        - crDroid
        - DerpFest
        - Evolution X
        - PixelOS
        - ArrowOS
        - RisingOS
        - Project Elixir
        - Corvus OS
        - Cherish OS
        - Awaken OS
        - PixelExperience
        - Havoc OS
        - AOSP
        - Custom (Input URL manually)
      
      custom_manifest_url:
        description: 'Custom Manifest URL (Only if "Custom" selected)'
        required: false
        default: ''

      branch:
        description: 'ROM Branch (e.g., lineage-23.0, 16.0, fifteen, baklava)'
        required: true
        default: 'lineage-23.0'

      treble_branch:
        description: 'Treble Manifest Branch (android-16.0, android-15.0, etc.)'
        required: true
        default: 'android-16.0'
        type: choice
        options:
        - android-16.0
        - android-15.0
        - android-14.0
        - android-13.0
        - android-12.1
        - android-11.0
        - android-10.0

      device:
        description: 'Lunch Variant'
        required: true
        default: 'treble_arm64_bvN-userdebug'
        type: choice
        options:
        - treble_arm64_bvN-userdebug
        - treble_arm64_bgN-userdebug
        - treble_a64_bvN-userdebug
        - treble_arm64_bvS-userdebug
        - treble_arm_bvN-userdebug
        - treble_arm64_bvZ-userdebug

      use_ccache:
        description: 'Enable ccache (speeds up rebuilds)'
        required: false
        default: true
        type: boolean

      clean_build:
        description: 'Clean build (removes previous artifacts)'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Free Up Disk Space
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: ""

      - name: Additional Disk Cleanup
        run: |
          echo "=== Available space before cleanup ==="
          df -h
          
          echo "Removing unnecessary files..."
          sudo rm -rf /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /usr/local/lib/android 2>/dev/null || true
          sudo rm -rf /opt/ghc 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL 2>/dev/null || true
          
          # Only prune docker if it's available
          if command -v docker &> /dev/null; then
            echo "Pruning Docker images..."
            sudo docker image prune --all --force || true
          else
            echo "Docker not available, skipping docker cleanup"
          fi
          
          echo "=== Available space after cleanup ==="
          df -h

      - name: Setup Build Scripts
        run: |
          chmod +x scripts/*.sh
          echo "Build scripts are now executable"

      - name: Setup Build Environment
        run: ./scripts/setup-environment.sh

      - name: Set Java Version
        run: ./scripts/set-java-version.sh "${{ inputs.treble_branch }}"

      - name: Configure ROM Source
        run: ./scripts/configure-rom.sh "${{ inputs.rom_type }}" "${{ inputs.custom_manifest_url }}"

      - name: Initialize and Sync Repository
        run: ./scripts/sync-source.sh "${{ inputs.branch }}" "${{ inputs.treble_branch }}"

      - name: Setup Treble Environment
        run: ./scripts/setup-treble.sh

      - name: Setup ccache
        if: inputs.use_ccache
        run: ./scripts/setup-ccache.sh

      - name: Clean Previous Build
        if: inputs.clean_build
        run: |
          cd ~/rom
          echo "ðŸ§¹ Cleaning previous build artifacts..."
          rm -rf out/

      - name: Build GSI
        run: ./scripts/build-gsi.sh "${{ inputs.device }}" "${{ inputs.use_ccache }}"

      - name: Show ccache Statistics
        if: inputs.use_ccache
        run: ccache -s

      - name: Compress and Package Output
        run: ./scripts/package-output.sh "${{ inputs.rom_type }}" "${{ inputs.branch }}" "${{ inputs.device }}" "${{ inputs.treble_branch }}"

      - name: Upload Build Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gsi-${{ inputs.rom_type }}-${{ inputs.branch }}-${{ inputs.device }}
          path: |
            ~/rom/out/target/product/*/system.img.xz
            ~/rom/out/target/product/*/build-info.txt
          retention-days: 14
          compression-level: 0

      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ inputs.rom_type }}-${{ inputs.branch }}
          path: |
            ~/rom/build.log
            ~/rom/out/error.log
            ~/rom/out/verbose.log.gz
          retention-days: 7
          if-no-files-found: ignore

      - name: Build Summary
        if: always()
        run: ./scripts/build-summary.sh "${{ inputs.rom_type }}" "${{ inputs.branch }}" "${{ inputs.treble_branch }}" "${{ inputs.device }}" "${{ inputs.use_ccache }}" "${{ inputs.clean_build }}"
